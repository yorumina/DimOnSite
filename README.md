# DimOnSite v2.0 — 依網站自動調整螢幕亮度（AHK v2）

當你切到指定網站時，自動將**筆電內建螢幕**調暗；離開後恢復正常亮度。主螢幕看影片不受副螢幕影響，日常使用不打擾。v2.0 全面升級：提供**深色控制面板**、即時預覽、開機自啟動，以及更穩定的行為。

---

## 功能

* **依網站關鍵字自動調亮/調暗**
  以目前分頁標題關鍵字判斷（如 `Netflix`…），命中時降亮度，離開恢復。
* **多瀏覽器支援**
  Chrome / Edge / Firefox / Brave / Opera。
* **不重複調整**
  只有狀態改變才下指令，避免頻繁閃爍。
* **深色控制面板（新）**
  一頁式 GUI（F10 或工作列圖示開啟），可**新增/刪除網站**、勾選啟用、調整亮度與檢查間隔，並**即時預覽**。
* **開機自啟動（新）**
  勾選「開機自啟動」後，自動建立排程（Highest），確保有權限調整亮度。
* **托盤整合 & 熱鍵**
  托盤選單可一鍵開啟控制面板、暫停/恢復。提供快速熱鍵（見下）。
* **安全收尾**
  結束腳本時自動把亮度拉回 **normal**。

---

## 系統需求

* Windows 10/11（內建 PowerShell）
* AutoHotkey **v2.0**（務必 v2）
* **筆電內建面板**支援 WMI 亮度（外接螢幕多半不支援）

---

## 安裝與啟動

1. 安裝 AutoHotkey v2。
2. 將本腳本（`DimOnSiteV2.0.ahk`）存到任一資料夾並執行。
3. **首次啟動若非系統管理員**，腳本會自動嘗試以 `*RunAs` 重新啟動（會看到 UAC 提示一次）。

---

## 控制面板（F10 / 托盤 → 控制面板…）

### 網站清單

* 勾選＝啟用；未勾選則忽略。
* **新增**：輸入關鍵字（比對分頁標題，例如 `YouTube`、`Disney+`），按「新增」。
* **刪除**：選取清單項目後按「刪除」。

### 亮度設定

* **命中時亮度**：命中清單任一關鍵字時使用的亮度。
* **正常亮度**：未命中時的亮度。
* 兩個滑桿都支援**即時預覽**（拖曳時就會套用到螢幕）。
* 每個滑桿下方會顯示目前的 **%**。

### 其他選項

* **允許 0%（可能如黑屏）**：開啟後命中可降到 0%；請自行評估機型是否可用。
* **開機自啟動**：建立 Windows 工作排程；取消勾選會移除排程。
* **檢查間隔（毫秒，≥50）**：偵測前景視窗頻率。

### 動作按鈕

* **還原**：立即恢復到「正常亮度」。
* **套用**：套用目前面板設定並儲存到 INI。

---

## 熱鍵

* **Ctrl + Alt + ↑**：立即恢復 **normal**。
* **Ctrl + Alt + ↓**：立即切到最暗（依 `允許 0%` 決定是 0% 或 `dim`）。
* **Ctrl + Alt + P**：**暫停/恢復** 自動偵測（托盤會提示）。
* **F10**：開關控制面板。

---

## 工作原理（簡述）

* 以設定的**檢查間隔**讀取前景視窗標題與行程名稱。
* 行程若為支援的瀏覽器，且標題包含任一清單關鍵字 ⇒ 狀態為 **dim**；否則為 **normal**。
* 僅在**狀態變更**時呼叫 PowerShell 透過 WMI `WmiSetBrightness` 調整亮度。
* 結束腳本時會自動把亮度拉回 `normal`。

---

## 設定檔（`DimOnSite.ini`）

* 儲存在與腳本同資料夾。
* 主要欄位：

  * `siteList`：`名稱|1, 名稱|0, ...`（1=啟用, 0=停用）
  * `dim`, `normal`, `useZero`, `interval`
* **相容 v1.x**：舊版的 `siteKeys` 仍會被讀取並轉換。

---

## 已知限制與小叮嚀

* **外接螢幕**多半不支援 WMI；本工具針對**筆電內建面板**最佳。外接螢幕可改用 DDC/CI 方案。
* 某些機型需完整晶片組/顯示器驅動，WMI 介面才正常。
* 若播放器全螢幕導致標題沒顯示，可能無法命中；可改用更泛用的關鍵字。
* 腳本使用 `ExecutionPolicy Bypass` 執行單一 PowerShell 指令，不會修改系統全域策略。

---

## 常見問題（FAQ）

**Q1：外接螢幕沒反應？**
A：正常。WMI 僅控制內建面板；外接螢幕需改用 DDC/CI 工具，至於什麼時候會支援?等我什麼時候買下我的夢想螢幕:D，OLED真的好貴:(。

**Q2：調到 0% 變黑？**
A：把「允許 0%」取消勾選，或把「命中時亮度」拉到 1–5%。也可按 **Ctrl+Alt+↑** 立刻救回。

**Q3：權限相關錯誤？**
A：腳本會在啟動時自動以系統管理員權限重新執行；若你拒絕 UAC，遇到某些擁有系統管理員權限之應用程式會報錯。

**Q4：下次更新時間？**
A：基本上這是最後版本了，除非我自己遇到bug或者是等我買新螢幕想做DDC/CI的版本再說吧:)。

---

## 版本資訊（Changelog）

### v2.0

* **全新深色控制面板**：一頁式設定、網站清單管理、滑桿**即時預覽**、按鈕 hover/按下動態。
* **開機自啟動**：透過 Windows 工作排程；面板內一鍵啟用/停用。
* **UI 強化**：清單無表頭、深色樣式、輸入框深灰與框線、簽名與按鈕對齊。
* **相容性**：可讀舊版 `siteKeys`，自動轉為 v2.0 的 `siteList`。
* **Bug 修正**：百分比數字偶發不顯示、與管理員權限相關的錯誤、若干佈局與邏輯瑕疵。

### v1.1

* 針對需要管理員權限的前景程式，修正偵測/操作錯誤；加入自動提權。

### v1.0

* 初版：依網站關鍵字自動降亮、多瀏覽器支援、狀態變更才調整、熱鍵與安全收尾。

---

## 移除方式

1. 在控制面板取消勾選「**開機自啟動**」以刪除排程。
2. 關閉腳本，刪除 `DimOnSiteV2.0.ahk` 與 `DimOnSite.ini`。

---

**作者**：閒閒沒事做的yoru
